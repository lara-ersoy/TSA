import pandas as pd
import matplotlib.pyplot as plt
import math

def compute_acf(series, max_lag=30):
    """
    Computing autocorrelation function for the last 1 up to the max_lag
    """
    acf_vals = []
    r = series.values
    n = len(r)
    mean_r = sum(r) / n  

    var_r = sum((x - mean_r) ** 2 for x in r)

    # Looping over each lag from 1 up until max_lag
    for lag in range(1, max_lag + 1):
        cov = sum((r[t] - mean_r) * (r[t - lag] - mean_r) for t in range(lag, n))
        acf_vals.append(cov / var_r)

    return acf_vals

def main():
    """
    Calculates daily log-returns, then plots the rates and the log-returns.
    Also makes an autocorrelation plot of the log-returns.
    """

    # Reading data
    file_path = "FVX_data_cleaned.csv"
    df = pd.read_csv(file_path, index_col=0, parse_dates=True)
    df.columns = ["Price"]

    # Ensuring price is numeric
    df["Price"] = pd.to_numeric(df["Price"], errors="coerce")
    df.dropna(subset=["Price"], inplace=True)

    # Computing the daily log-returns manually
    log_returns = [None] 
    for i in range(1, len(df)):
        log_return = math.log(df.iloc[i, 0] / df.iloc[i - 1, 0])
        log_returns.append(log_return)

    df["log_ret"] = log_returns
    df.dropna(inplace=True) 

    # Plotting the log-return rates and the rates
    fig, axes = plt.subplots(nrows=2, ncols=1, figsize=(10, 6), sharex=True)

    axes[0].plot(df.index, df["Price"], label="5-year treasury yield level", color="skyblue")
    axes[0].set_title("5-year treasury yield over time")
    axes[0].set_ylabel("Yield (in %)")
    axes[0].legend(loc="upper left")

    axes[1].plot(df.index, df["log_ret"], color="pink", label="Daily log-returns")
    axes[1].set_title("Log-returns over time")
    axes[1].set_ylabel("Log-returns")
    axes[1].legend(loc="upper left")

    plt.tight_layout()
    plt.show()

    # Computing the ACF of log-returns and plotting it
    max_lag = 30
    acf_vals = compute_acf(df["log_ret"], max_lag=max_lag)

    plt.figure(figsize=(8, 4))
    plt.bar(range(1, max_lag + 1), acf_vals, color="purple", width=0.6)
    plt.title("Autocorrelation of the log-returns")
    plt.xlabel("Lag")
    plt.ylabel("ACF")
    plt.axhline(y=0, color="black", linewidth=1)
    plt.show()

if __name__ == "__main__":
    main()
