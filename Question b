import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

def compute_acf(series, max_lag=30):
    """
    Compute autocorrelation function for the last 1 up to the max_lag
    """
    acf_vals = []
    r = series.values
    n = len(r)
    mean_r = np.mean(r)

    # var_r should be the sum of squared deviations from the mean
    var_r = np.sum((r - mean_r)**2)

    # Loop over each lag from 1..max_lag
    for lag in range(1, max_lag + 1):
        cov = 0.0
        for t in range(lag, n):
            cov += (r[t] - mean_r) * (r[t - lag] - mean_r)
        acf_vals.append(cov / var_r)
    
    return acf_vals

def main():
    """
    Calculates daily log-returns, then plots the rates and the log-returns.
    Also makes an autocorrelation plot of the log-returns.
    """

    # Read data
    df = pd.read_csv("FVX_data.csv", index_col=0, parse_dates=True)
    df.columns = ["Price"]
    df.index = pd.to_datetime(df.index, errors="coerce")

    # Check if the price is numeric
    df["Price"] = pd.to_numeric(df["Price"], errors="coerce")
    df.dropna(subset=["Price"], inplace=True)

    # Computing the daily-returns
    df["log_ret"] = np.log(df["Price"] / df["Price"].shift(1))
    df.dropna(inplace=True)

    # Plotting the log-return rates and the rates
    fig, axes = plt.subplots(nrows=2, ncols=1, figsize=(10, 6), sharex=True)

    axes[0].plot(df.index, df["Price"], label="5-year treasury yield level")
    axes[0].set_title("5-year treasury yield over time")
    axes[0].set_ylabel("yield (in %)")
    axes[0].legend(loc="upper left")

    axes[1].plot(df.index, df["log_ret"], color="orange", label="Daily log-returns")
    axes[1].set_title("Log-returns over time")
    axes[1].set_ylabel("Log-returns")
    axes[1].legend(loc="upper left")

    plt.tight_layout()
    plt.show()

    # Compute the ACF of log-returns and plot it
    max_lag = 30
    acf_vals = compute_acf(df["log_ret"], max_lag=max_lag)

    plt.figure(figsize=(8, 4))
    plt.bar(range(1, max_lag + 1), acf_vals, color="purple", width=0.6)
    plt.title("Autocorrelation of the log-Returns")
    plt.xlabel("Lag")
    plt.ylabel("ACF")
    plt.axhline(y=0, color="skyblue", linewidth=1)
    plt.show()

if __name__ == "__main__":
    main()
