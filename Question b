import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

def compute_acf(series, max_lag=30):
    """
    Compute autocorrelation function for the las 1 up to the max_lag
    """
    acf_vals = []
    r = series.values
    n = len(r)
    mean_r = np.mean(r)
    var_r = np.sum

    for lag in range(1, max_lag+1):
        cov = 0.0
        for t in range(lag, n):
            cov+=(r[t]-mean_r)*(r[t-lag]-mean_r)
        acf_vals.append(cov/var_r)    
        
    for lag in range(1, max_lag + 1):
            cov = 0.0
            for t in range(lag, n):
                cov += (r[t] - mean_r)*(r[t-lag] - mean_r)
            acf_vals.append(cov / var_r)
    
    return acf_vals

def main():
    """
    Calculates daily log-returns the plot rates and the log returns.
    Makes autocorrelation plot of the log-returns.
    """

    # Read data
    df = pd.read_csv("FVX_data.csv", index_col=0, parse_dates=True)
    df.columns = ["Price"]
    df.index = pd.to_datetime(df.index, errors="coerce")

    # Check if the price is numeric
    df["Price"] = pd.to_numeric(df["Price"], errors="coerce")
    df.dropna(subset=["Price"], inplace=True)

    # Computing the daily-returns
    df["log_ret"] = np.log(df["Price"] / df["Price"].shift(1))
    df.dropna(inplace=True)

    # Plotting the log-return rates and the rates
    fig, axes = plt.subplots(nrows=2, ncols=1, figsize=(10, 6), sharex=True)

    axes[0].plot(df.index, df["Price"], label="5-year treasury yield level")
    axes[0].set_title("5-year treasury yield over time")
    axes[0].set_ylabel("yield (in %)")
    axes[0].legend(loc="upper left")

    axes[1].plot(df.index, df["log_ret"], color="orange", label="Daily log-returns")
    axes[1].set_title("Log-returns over time")
    axes[1].set_ylabel("Log-returns")
    axes[1].legend(loc="upper left")

    plt.tight_layout()
    plt.show()
