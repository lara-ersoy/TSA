import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import yfinance as yfin
from scipy.optimize import minimize

# PART 2 (a) - Loading in data and compute log returns
df = yfin.download("^TNX", start="2010-01-01", end="2023-12-31")
df['Log_Returns'] = np.log(df['Close'] / df['Close'].shift(1))
df.dropna(inplace=True)

# PART 2 (b) - Estimating AR(p) models
def estimating_ar_model(y, p):
    X = np.column_stack([y.shift(i) for i in range(1, p+1)])
    X = np.hstack([np.ones((X.shape[0], 1)), X])  # Adding intercept
    y = y[p:]  # Dependent variable
    X = X[p:, :]  # Independent variables
    
    beta = np.linalg.inv(X.T @ X) @ X.T @ y  # OLS estimation formula
    residuals = y - X @ beta
    sigma2 = np.var(residuals)
    log_llh = -0.5 * len(y) * np.log(2 * np.pi * sigma2) - (residuals @ residuals) / (2 * sigma2)
    aic = -2 * log_llh + 2 * len(beta)
    
    return log_llh, aic, beta

# PART 2 (c) - Rolling Window Forecasting
def rolling_window_forecast(y, p, window=750):
    forecasts = []
    actuals = []
    
    for i in range(window, len(y)):
        train = y[i-window:i]
        _, _, beta = estimating_ar_model(train, p)
        X_new = np.hstack([1, train[-p:].values[::-1]])  
        forecast = X_new @ beta
        forecasts.append(forecast)
        actuals.append(y.iloc[i])
    
    forecasts = np.array(forecasts)
    actuals = np.array(actuals)
    rmse = np.sqrt(np.mean((forecasts - actuals) ** 2))
    
    return rmse

# PART 2 (d) - Expanding Window Forecasting
def expanding_window_forecast(y, p, start_size=750):
    forecasts = []
    actuals = []
    
    for i in range(start_size, len(y)):
        train = y[:i]
        _, _, beta = estimating_ar_model(train, p)
        X_new = np.hstack([1, train[-p:].values[::-1]])  
        forecast = X_new @ beta
        forecasts.append(forecast)
        actuals.append(y.iloc[i])
    
    forecasts = np.array(forecasts)
    actuals = np.array(actuals)
    rmse = np.sqrt(np.mean((forecasts - actuals) ** 2))
    
    return rmse

# PART 2 (e & f) - RMSE Comparison and Final Model Selection
rmse_results = {"p": [], "Rolling RMSE": [], "Expanding RMSE": []}

for p in range(1, 6):
    rolling_rmse = rolling_window_forecast(df['Log_Returns'], p)
    expanding_rmse = expanding_window_forecast(df['Log_Returns'], p)
    rmse_results["p"].append(p)
    rmse_results["Rolling RMSE"].append(rolling_rmse)
    rmse_results["Expanding RMSE"].append(expanding_rmse)

# Convert to DataFrame and Print Results
rmse_df = pd.DataFrame(rmse_results)
print("RMSE Comparison:")
print(rmse_df)

# Plot RMSE Comparison
plt.figure(figsize=(10, 5))
plt.plot(rmse_df["p"], rmse_df["Rolling RMSE"], marker='o', label="Rolling RMSE", color='purple')
plt.plot(rmse_df["p"], rmse_df["Expanding RMSE"], marker='s', label="Expanding RMSE", color='red')
plt.xlabel("AR order (p)")
plt.ylabel("RMSE")
plt.title("RMSE Comparison for Rolling vs. Expanding Window Forecasting")
plt.legend()
plt.savefig("4Figure_6.png")
plt.show()